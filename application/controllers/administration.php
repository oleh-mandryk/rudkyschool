<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');
class Administration extends CI_Controller
{
    public function __construct()
    {
        parent::__construct();
    }
    
    public function index()
    {
        $this->auth_lib->check_admin();
        
        $this->load->model('pages_model');
        $this->load->model('sections_model');
        
        $data = array();
        
        //Âñüîãî ìàòåğ³àë³â
        $data['materials_count'] = $this->materials_model->count_all();
        
        //Âñüîãî ñòîğ³íîê
        $data['pages_count'] = $this->pages_model->count_all(); 
        
        //Âñüîãî êàòåãîğ³é
        $data['sections_count']    = $this->sections_model->count_all();
        
        //ìàñèâ ç ïóíêòàìè êàòåãîğ³é (ãîëîâíå ìåíş);
        $data['menu_main'] = $this->menu_main_model->get_other();
        
        //ìàñèâ ç ïóíêòàìè âåğõíüîãî ìåíş;
        $data['menu_top'] = $this->menu_top_model->get_other();
        
        //êàğòèíêè äëÿ ôóòåğà
        $data['img_footer'] = $this->img_footer_model->get_other();
        
        //âèòÿãóºìî ç áàçè îñòàíí³ îíîâëåí³ ìàòåğ³àëè
        $data['update_materias']= $this->materials_model->update_materias();
                      
        $name = 'main_admin';
        $this->display_lib->admin_page($data,$name);
    }
    
    public function preferences()
    {
        $this->auth_lib->check_admin();
        
        $data = array();
        $data['menu_top'] = $this->menu_top_model->get_other();
        $data['menu_main'] = $this->menu_main_model->get_other();
        $data['img_footer'] = $this->img_footer_model->get_other();
        
        //ßêùî íàòèñíóòà êíîïêà "Îíîâèòè"
        if (isset($_POST['update_button']))
        {
            //Âñòàíîâëåííÿ ïğàâèë âàë³äàö³¿
            $this->form_validation->set_rules($this->administration_model->preferences_rules);
            
            //ßêùî âàë³äàö³ÿ óñï³øíî ïğîéäåíà
            if ($this->form_validation->run() == TRUE)
            {
                //Çàíîñèìî â ìàñèâ data îòğèìàí³ ç ôîğìè çì³íí³
                $data_admin = array();
                $data_admin['user_per_page']   = $this->input->post('user_per_page');
                $data_admin['admin_per_page']  = $this->input->post('admin_per_page');
                $data_admin['admin_login']     = $this->input->post('admin_login');
                $data_admin['admin_pass']      = $this->input->post('admin_pass');
                $data_admin['search_per_page'] = $this->input->post('search_per_page');
                $data_admin['user_per_photo'] = $this->input->post('user_per_photo');
                
                foreach ($data_admin as $key => $value)
                {    
                    //Îíîâëåííÿ â öèêë³ äëÿ êîæíî¿ íàñòğîéêè      
                    $this->db->where('pref_id',$key);
                    
                    //Äğóãèé ïàğàìåòğ äëÿ update - ìàñèâ (ïîëş âàëó ïğèñâîşºìî çíà÷åííÿ çì³ííî¿ $value)
                    $this->db->update('preferences',array('value' => $value));
                }
                
                $name='info_ok';
                $data['info'] = 'Íàëàøòóâàííÿ îíîâëåí³';
                $this->display_lib->admin_info_page($data,$name);
            }
            
            //ßêùî âàë³äàö³ÿ íå ïğîéäåíà
            else
            {
                $name = 'preferences';
                $this->display_lib->admin_page($data,$name);
            }
        }
        
        //Êíîïêà "Îíîâèòè" íå íàòèñíóòà
        else
        {
            $name = 'preferences';
            $this->display_lib->admin_page($data,$name);
        }
    }
    
    public function login()
    {
        //Âñòàíîâëåííÿ ïğàâèë âàë³äàö³¿
        $this->form_validation->set_rules($this->administration_model->login_rules);

        //ßêùî âàë³äàö³ÿ íå ïğîéäåíà
        if ($this->form_validation->run() == FALSE)
        {
            $this->display_lib->login_page();
        }

        //ßêùî âàë³äàö³ÿ ïğîéäåíà, íàìàãàºìîñÿ ââ³éòè
        else
        {
            $this->auth_lib->do_login($this->input->post('login'),$this->input->post('pass'));
        }
    }
    
    public function logout()
    {
        //Ïåğåâ³ğÿºìî, ÷è áóâ çä³éñíåíèé âõ³ä
        $this->auth_lib->check_admin();//Òóò ïåğåâ³ğêà íå òàê îáîâ'ÿçêîâà â ïğèíöèï³
        $this->auth_lib->do_logout();
    }
  
    public function search($start_from = 0)
    {
        $this->load->library('pagination');
        $this->load->library('pagination_lib');
        
        //Äëÿ ï³äñâ³÷óâàííÿ ïîøóêîâîãî çàïèòó ó âèãëÿä³(view) ç ğåçóëüòàòàìè ïîøóêó
        $this->load->helper('text'); 

        // Ôîğìèğóåì ıëåìåíòû, íóæíûå â ëşáîì ñëó÷àå
        $data = array();
        
        //êàëåíäàğ
        $data['calendar'] = $this->calendar->generate();
        
        //ìàñèâ ç ïóíêòàìè êàòåãîğ³é (ãîëîâíå ìåíş);
        $data['menu_main'] = $this->menu_main_model->get_other();
        
        //ìàñèâ ç ïóíêòàìè âåğõíüîãî ìåíş;
        $data['menu_top'] = $this->menu_top_model->get_other();
        
        //êàëåíäàğ;
        $data['calendar'] = $this->calendar->generate();
        
        //êàğòèíêè äëÿ ôóòåğà
        $data['img_footer'] = $this->img_footer_model->get_other();
        
        //ìàñèâ ïî ö³êàâî çíàòè
        $data['i_wonder'] = $this->i_wonder_model->i_wonder($start_from_i_wonder = rand (0, $total = $this->i_wonder_model->count_all()-1));
        
        //ìàñèâ ïî ö³êàâî çíàòè
        $data['winged_phrases'] = $this->winged_phrases_model->winged_phrases($start_from_winged_phrases = rand (0, $total = $this->winged_phrases_model->count_all()-1));
        
        //âèòÿãóºìî ç áàçè âñ³ çàïèòàííÿ äî ãîëîñóâàííÿ
        $data['questions_vote_all']= $this->ques_model->get_other();
        
        //âèòÿãóºìî ç áàçè âñ³ â³äïîâ³ä³ äëÿ ãîëîñóâàííÿ
        $data['options_vote_all']= $this->options_model->get_other();
        
        //âèòÿãóºìî ç áàçè îñòàíí³ îíîâëåí³ ìàòåğ³àëè
        $data['update_materias']= $this->materials_model->update_materias();
        
        //Çàäàºìî ê³ëüê³ñòü ğåçóëüòàò³â ïîøóêó íà ñòîğ³íêó
        $limit = $this->config->item('search_per_page');
        
        //ßêùî íàòóñíóòà êíîïêà "Ïîøóê"
        if (isset($_POST['search_button']))
        {  
            //Âñòàíîâëşºìî ïğàâèëà âàë³äàö³¿
            $this->form_validation->set_rules($this->administration_model->search_rules);
            $val_res = $this->form_validation->run();

            // Ôîğìóºìî ìàñèâ ç ïóñòèìè çíà÷åííÿìè
            $ses_search = array();
            $ses_search['val_passed'] = ''; // ×è ïğîéøëà âàë³äàö³ÿ
            $ses_search['search_query'] = ''; // Ïîøóêîâèé çàïèò
            $this->session->set_userdata($ses_search);//Çàïèñóºìî ñåñ³ş
        
            //ßêùî âàë³äàö³ÿ ïğîéäåíà 
            if ($val_res == TRUE)
            {
                //TRUE - ô³ëüòğóºìî íà xss-àòàêó            
                $search = $this->input->post('search',TRUE);
            
                //Êîíâåğòóºìî ñïåö³àëüí³ ñèìâîëè â html-ñóòíîñò³, ùîá ââåäåíèé çàïèò íå ì³ñòèâ ğîçì³òêè html
                $search = htmlspecialchars($search); 
                
                //Çàïèñóºìî ñåñ³ş ï³ñëÿ ïğîõîäæåííÿ âàë³äàö³¿
                $ses_search = array();    
                
                //Âàë³äàö³ÿ ïğîéäåíà óñï³øíî äëÿ ïîøóêîâîãî çàïèòó       
                $ses_search['val_passed'] = 'yes'; 
                
                //Ïîøóêîâèé çàïèò
                $ses_search['search_query'] = $search;  
                
                //Çàïèñóºìî ñåñ³ş
                $this->session->set_userdata($ses_search);
                
                //Ìàñèâ ïî çíàéäåíèõ ìàòåğ³àëàõ ³ ñòîğ³íêàõ
                $mpsearch_results = $this->administration_model->materials_pages_search($search,$limit,$start_from);
                       
                //ßêùî ìàñèâ ïóñòèé
                if (empty ($mpsearch_results))
                    {                      
                        $data['info'] = '²íôîğìàö³ÿ ïî Âàøîìó çàïèòó íà çíàéäåíà';                             
                        $data['title_info']='Ğåçóëüòàòè ïîøóêó';
                        $name = 'info_error';
                        $this->display_lib->user_info_page($data,$name);
                    }
                //Ïîøóê äàâ ğåçóëüòàò
                else
                {   
                    //Ğàõóºìî çàãàëüíó ê³ëüê³ñòü ñòîğ³íîê, ÿê³  ì³ñòÿòü ïîøóêîâèé çàïèò
                    $total = $mpsearch_results['counter']; 
                
                    //Íàëàøòóâàííÿ (äëÿ ÷îãî íàâ³ãàö³ÿ, ³ì'ÿ äëÿ ï³äñòàíîâêè äî base_url, âñüîãî, îáìåæåííÿ)
                    $settings = $this->pagination_lib->get_settings('search','',$total,$limit);
                    
                    //Ïğèéìàºìî íàëàøòóâàííÿ
                    $this->pagination->initialize($settings);
                    
                    //Ìàñèâ ïî çíàéäåíèõ ìàòåğ³àëàõ ³ ñòîğ³íêàõ
                    $data['mpsearch_results'] = $mpsearch_results;
                                    
                    //ïîñèëàííÿ pagination         
                    $data['page_nav'] = $this->pagination->create_links();
                     
                    $name = 'admin/search';
                    $data['title_info']='Ğåçóëüòàòè ïîøóêó';
                    $this->display_lib->user_info_page($data,$name);            
                }
            }
            //ßêùî âàë³äàö³ÿ íå ïğîéäåíà
            else
            {
                $data['info'] = 'Íåïğàâèëüí³ ïàğàìåòğè ïîøóêó';                              
                $data['title_info']='Íåïğàâèëüí³ ïàğàìåòğè ïîøóêó';
                $name = 'info_error';                  
                $this->display_lib->user_info_page($data,$name);
            }
        }
        //ßêùî íå íàæàòà êíîïêà "Ïîøóê"
        else
        {
        //Àëå â ñåñ³¿ çáåğ³ãàºòüñÿ ³íôîğìàö³ÿ ïğî óñï³øíî ïğîéäåíó âàë³äàö³ş
        if ($this->session->userdata('val_passed') === 'yes')
        {
            //Çàíîñèìî â çì³ííó search ğÿäîê ïîøóêîâîãî çàïèòó, ùî çáåğåæåíèé â ñåñ³¿
            $search = $this->session->userdata('search_query');

            //Ìàñèâ ïî çíàéäåíèõ ìàòåğ³àëàõ ³ ñòîğ³íêàõ
            $mpsearch_results = $this->administration_model->materials_pages_search($search,$limit,$start_from);
                        
            // ßêùî ìàñèâ ïóñòèé
            if (empty ($mpsearch_results))
            {                       
                $data['info'] = '²íôîğìàö³ÿ ïî Âàøîìó çàïèòó íå çíàéäåíà';                             
                $data['title_info']='Ğåçóëüòàòè ïîøóêó';
                $name = 'info';
                $this->display_lib->user_info_page($data,$name);            
            }
            // Ïîøóê äàâ ğåçóëüòàò
            else
            {
                //Ğàõóºìî çàãàëüíó ê³ëüê³ñòü ñòîğ³íîê, ÿê³ ì³ñòÿòü ïîøóêîâèé çàïèò
                $total = $mpsearch_results['counter'];
                
                //Íàëàøòóâàííÿ (äëÿ ÷îãî íàâ³ãàö³ÿ, ³ì'ÿ äëÿ ï³äñòàíîâêè äî base_url, âñüîãî, îáìåæåííÿ)
                $settings = $this->pagination_lib->get_settings('search','',$total,$limit);

                //Ïğèéìàºìî íàëàøòóâàííÿ
                $this->pagination->initialize($settings);
                
                //Ìàñèâ ïî çíàéäåíèõ ìàòåğ³àëàõ ³ ñòîğ³íêàõ
                $data['mpsearch_results']  = $mpsearch_results;
                                               
                //ïîñèëàííÿ pagination
                $data['page_nav'] = $this->pagination->create_links(); 
                $data['title_info']='Ğåçóëüòàòè ïîøóêó';
                $name = 'admin/search';           
                $this->display_lib->user_info_page($data,$name);
            }
        }
        // è â ñåññèè íåò èíôîğìàöèè îá óñïåøíîì ïğîõîæäåíèè âàëèäàöèè
        else
        {
            $data['info'] = 'Íåïğàâèëüí³ ïàğàìåòğè ïîøóêó';                          
            $data['title_info']='Íåïğàâèëüí³ ïàğàìåòğè ïîøóêó';
            $name = 'info_error';
            $this->display_lib->user_info_page($data,$name);
        }
        }
    }
    
}
?>